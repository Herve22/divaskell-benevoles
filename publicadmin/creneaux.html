<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“… CrÃ©neaux</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .table-actions { white-space: nowrap; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
    .status-ok { background: #d4edda; color: #155724; }
    .status-warn { background: #fff3cd; color: #856404; }
    .status-danger { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1>ğŸ“… Gestion des CrÃ©neaux</h1>
    
    <button class="btn btn-primary mb-3" onclick="loadCreneaux()">ğŸ”„ Actualiser</button>
    <div id="message" class="alert d-none"></div>
    
    <div id="creneaux-list"></div>
    
    <div class="mt-5">
      <h3>â• Ajouter un crÃ©neau</h3>
      <form id="form-add" onsubmit="createCreneau(event)">
        <div class="row">
          <div class="col-md-6">
            <select id="groupe_id" class="form-control mb-2" required>
              <option value="">-- SÃ©lectionner un groupe --</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="number" id="nb_min" placeholder="Min" value="1" min="1" class="form-control mb-2" required>
          </div>
          <div class="col-md-3">
            <input type="number" id="nb_max" placeholder="Max" value="5" min="1" class="form-control mb-2" required>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <label>DÃ©but</label>
            <input type="datetime-local" id="debut" class="form-control mb-2" required>
          </div>
          <div class="col-md-6">
            <label>Fin</label>
            <input type="datetime-local" id="fin" class="form-control mb-2" required>
          </div>
        </div>
        <input type="text" id="notes" placeholder="Notes (optionnel)" class="form-control mb-2">
        <button type="submit" class="btn btn-success">CrÃ©er le crÃ©neau</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
async function loadCreneaux() {
  try {
    const res = await fetch('/api/creneaux');
    const data = await res.json();
    const list = document.getElementById('creneaux-list');
    
    if (!data.creneaux || data.creneaux.length === 0) {
      list.innerHTML = '<div class="alert alert-info">Aucun crÃ©neau crÃ©Ã©</div>';
      return;
    }
    
    list.innerHTML = `
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Groupe</th>
            <th>PÃ©riode</th>
            <th>CapacitÃ©</th>
            <th>Inscrits</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${data.creneaux.map(c => {
            const status = getStatus(c);
            const debut = new Date(c.debut);
            const fin = new Date(c.fin);
            return `
              <tr>
                <td>${c.groupe_nom || 'Groupe ' + c.groupe_id}</td>
                <td>
                  ${debut.toLocaleDateString('fr-FR')}<br>
                  <small>${debut.toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'})} - 
                  ${fin.toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'})}</small>
                </td>
                <td>${c.nb_min}-${c.nb_max}</td>
                <td><strong>${c.nb_inscrits || 0}</strong></td>
                <td><span class="status-badge status-${status.class}">${status.text}</span></td>
                <td class="table-actions">
                  <button class="btn btn-sm btn-info" onclick="viewInscrits(${c.id})">ğŸ‘¥</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteCreneau(${c.id})">ğŸ—‘ï¸</button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    `;
  } catch (err) {
    console.error(err);
    showMessage('Erreur de chargement', 'danger');
  }
}

async function loadGroupes() {
  try {
    const res = await fetch('/api/groupes');
    const data = await res.json();
    const select = document.getElementById('groupe_id');
    select.innerHTML = '<option value="">-- SÃ©lectionner un groupe --</option>' +
      data.groupes.map(g => `<option value="${g.id}">${g.nom}</option>`).join('');
  } catch (err) {
    console.error(err);
  }
}

function getStatus(creneau) {
  const inscrits = creneau.nb_inscrits || 0;
  if (inscrits < creneau.nb_min) return { class: 'danger', text: 'Manque' };
  if (inscrits === creneau.nb_min) return { class: 'warn', text: 'Minimum' };
  if (inscrits >= creneau.nb_max) return { class: 'ok', text: 'Complet' };
  return { class: 'ok', text: 'OK' };
}

async function createCreneau(e) {
  e.preventDefault();
  const data = {
    groupe_id: document.getElementById('groupe_id').value,
    debut: document.getElementById('debut').value,
    fin: document.getElementById('fin').value,
    nb_min: document.getElementById('nb_min').value,
    nb_max: document.getElementById('nb_max').value,
    notes: document.getElementById('notes').value
  };
  
  try {
    const res = await fetch('/api/creneaux', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    if (res.ok) {
      document.getElementById('form-add').reset();
      loadCreneaux();
      showMessage('CrÃ©neau crÃ©Ã©', 'success');
    }
  } catch (err) {
    showMessage('Erreur de crÃ©ation', 'danger');
  }
}

async function deleteCreneau(id) {
  if (!confirm('Supprimer ce crÃ©neau et toutes ses inscriptions ?')) return;
  try {
    await fetch(`/api/creneaux/${id}`, { method: 'DELETE' });
    loadCreneaux();
    showMessage('CrÃ©neau supprimÃ©', 'success');
  } catch (err) {
    showMessage('Erreur de suppression', 'danger');
  }
}

async function viewInscrits(creneauId) {
  try {
    const res = await fetch(`/api/inscriptions?creneau_id=${creneauId}`);
    const data = await res.json();
    const inscrits = data.inscriptions || [];
    
    if (!inscrits.length) {
      alert('Aucun inscrit');
      return;
    }
    
    const list = inscrits.map(i => 
      `${i.prenom} ${i.nom} - ${i.email || 'Pas d\'email'} - ${i.telephone || 'Pas de tÃ©l'}`
    ).join('\n');
    
    alert(`Inscrits (${inscrits.length}):\n\n${list}`);
  } catch (err) {
    console.error(err);
  }
}

function showMessage(text, type) {
  const msg = document.getElementById('message');
  msg.className = `alert alert-${type}`;
  msg.textContent = text;
  msg.classList.remove('d-none');
  setTimeout(() => msg.classList.add('d-none'), 3000);
}

// Initialisation
loadCreneaux();
loadGroupes();
  </script>
</body>
</html>